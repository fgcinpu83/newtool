name: Node.js CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['main']
  workflow_dispatch: {}

jobs:
  test-backend:
    name: Backend CI (build + tests)
    runs-on: ${{ matrix.os }}
    env:
      NODE_ENV: test
      CI: true
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Print environment
        run: |
          echo "OS=${{ runner.os }}"
          node -v
          npm -v

      - name: Install backend dependencies (try `npm ci`, fallback to `npm install`)
        working-directory: ./backend
        run: |
          npm ci --no-audit --no-fund || npm install --no-audit --no-fund

      - name: Build backend
        working-directory: ./backend
        run: npm run build

      - name: Run backend tests
        working-directory: ./backend
        env:
          CI: true
        run: npm test -- -i --runInBand

      - name: List better-sqlite3 installation (diagnostic)
        working-directory: ./backend
        if: always()
        run: |
          echo "--- node_modules/better-sqlite3 (if present) ---"
          node -e "const fs=require('fs'); const d='node_modules'; try{ if(fs.existsSync(d)){ const names=fs.readdirSync(d).filter(n=>n.startsWith('better-sqlite3')); if(names.length) console.log(names.join('\\n')); else console.log('(none)'); } }catch(e){}"
          echo "--- end diagnostic ---"

      - name: Install frontend dependencies (try `npm ci`, fallback to `npm install`)
        working-directory: ./frontend_new
        run: |
          npm ci --no-audit --no-fund || npm install --no-audit --no-fund

      - name: Build frontend
        working-directory: ./frontend_new
        env:
          CI: true
        run: npm run build

      - name: List frontend node_modules (diagnostic)
        working-directory: ./frontend_new
        if: always()
        run: |
          echo "--- frontend node_modules snapshot ---"
          node -e "const fs=require('fs'); try{ const d='node_modules'; console.log(fs.existsSync(d)?'present':'missing'); }catch(e){}"
          echo "--- end diagnostic ---"

      # --- E2E simulation using the CI-built frontend (simulates frontend socket actions)
      # (backend start + E2E run are executed together per-OS to ensure the background server is reachable from the same shell)

      - name: Install root tools dependencies (for E2E script)
        working-directory: .
        run: |
          npm ci --no-audit --no-fund || npm install --no-audit --no-fund

      - name: Verify tools dependencies (`socket.io-client`)
        working-directory: .
        run: |
          node -e "try { require('socket.io-client'); console.log('socket.io-client OK'); } catch (e) { console.error('socket.io-client load failed', e && e.message); process.exit(1); }"

      - name: Start backend (background) + Run E2E (Linux)
        if: runner.os == 'Linux'
        working-directory: ./backend
        run: |
          npm run start:prod &
          for i in $(seq 1 20); do
            status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/health || echo 000)
            echo "backend health=$status"
            if [ "$status" -eq 200 ]; then echo 'backend ready'; break; fi
            sleep 0.5
          done
          node ../tools/e2e_ci_frontend_sim.js

      - name: Start backend (background) + Run E2E (Windows)
        if: runner.os == 'Windows'
        working-directory: ./backend
        shell: powershell
        run: |
          Start-Process -NoNewWindow -FilePath npm -ArgumentList 'run','start:prod'
          $ok = $false; for ($i=0; $i -lt 40; $i++) { try { $r = Invoke-WebRequest -Uri 'http://localhost:3001/health' -UseBasicParsing -TimeoutSec 2; if ($r.StatusCode -eq 200) { $ok = $true; break } } catch {}; Start-Sleep -Milliseconds 500 }; if (-not $ok) { Write-Error 'backend not ready'; exit 1 } else { Write-Host 'backend ready' }
          node ../tools/e2e_ci_frontend_sim.js

      - name: Stop backend (cleanup - Linux)
        if: runner.os == 'Linux'
        working-directory: ./backend
        run: |
          pkill -f 'node dist/src/main.js' || true

      - name: Stop backend (cleanup - Windows)
        if: runner.os == 'Windows'
        working-directory: ./backend
        shell: powershell
        run: |
          Get-Process node -ErrorAction SilentlyContinue | Where-Object { $_.Path -like '*dist\\src\\main.js*' } | Stop-Process -Force -ErrorAction SilentlyContinue || Write-Host 'no node dist process'
